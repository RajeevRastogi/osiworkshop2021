From c57cddd544d098651578e41499a30917f24fbc4b Mon Sep 17 00:00:00 2001
From: SURYA SUMANTH N <ssumanth21@gmail.com>
Date: Wed, 6 Oct 2021 19:11:34 +0530
Subject: [PATCH] Integer overflow when parsing dates beyond represent

---
 .../src/main/java/io/prestosql/type/DateOperators.java      | 2 +-
 .../test/java/io/prestosql/type/TestDateTimeOperators.java  | 6 ++++++
 .../src/main/java/io/prestosql/spi/util/DateTimeUtils.java  | 3 ++-
 3 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/presto-main/src/main/java/io/prestosql/type/DateOperators.java b/presto-main/src/main/java/io/prestosql/type/DateOperators.java
index a44104a4..1d4250ca 100644
--- a/presto-main/src/main/java/io/prestosql/type/DateOperators.java
+++ b/presto-main/src/main/java/io/prestosql/type/DateOperators.java
@@ -147,7 +147,7 @@ public final class DateOperators
         try {
             return parseDate(trim(value).toStringUtf8());
         }
-        catch (IllegalArgumentException e) {
+        catch (IllegalArgumentException | ArithmeticException e) {
             throw new PrestoException(INVALID_CAST_ARGUMENT, "Value cannot be cast to date: " + value.toStringUtf8(), e);
         }
     }
diff --git a/presto-main/src/test/java/io/prestosql/type/TestDateTimeOperators.java b/presto-main/src/test/java/io/prestosql/type/TestDateTimeOperators.java
index 4a2406dc..2663854a 100644
--- a/presto-main/src/test/java/io/prestosql/type/TestDateTimeOperators.java
+++ b/presto-main/src/test/java/io/prestosql/type/TestDateTimeOperators.java
@@ -409,6 +409,12 @@ public class TestDateTimeOperators
         assertInvalidFunction("DATE '392251590-07-12'", INVALID_CAST_ARGUMENT, "Value cannot be cast to date: 392251590-07-12");
     }
 
+    @Test
+    public void testDateCastParse()
+    {
+        assertInvalidFunction("DATE '5881580-07-12'", INVALID_CAST_ARGUMENT, "Value cannot be cast to date: 5881580-07-12");
+    }
+
     private static SqlDate toDate(DateTime dateTime)
     {
         return new SqlDate((int) TimeUnit.MILLISECONDS.toDays(dateTime.getMillis()));
diff --git a/presto-spi/src/main/java/io/prestosql/spi/util/DateTimeUtils.java b/presto-spi/src/main/java/io/prestosql/spi/util/DateTimeUtils.java
index 6de3f859..333bc43d 100644
--- a/presto-spi/src/main/java/io/prestosql/spi/util/DateTimeUtils.java
+++ b/presto-spi/src/main/java/io/prestosql/spi/util/DateTimeUtils.java
@@ -37,6 +37,7 @@ import static io.prestosql.spi.util.DateTimeZoneIndex.getDateTimeZone;
 import static io.prestosql.spi.util.DateTimeZoneIndex.packDateTimeWithZone;
 import static io.prestosql.spi.util.DateTimeZoneIndex.unpackChronology;
 import static io.prestosql.spi.util.DateTimeZoneIndex.unpackDateTimeZone;
+import static java.lang.Math.toIntExact;
 import static java.lang.String.format;
 
 public final class DateTimeUtils
@@ -49,7 +50,7 @@ public final class DateTimeUtils
 
     public static int parseDate(String value)
     {
-        return (int) TimeUnit.MILLISECONDS.toDays(DATE_FORMATTER.parseMillis(value));
+        return toIntExact(TimeUnit.MILLISECONDS.toDays(DATE_FORMATTER.parseMillis(value)));
     }
 
     public static String printDate(int days)
-- 
2.25.1

